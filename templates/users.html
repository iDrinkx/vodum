{% extends "base.html" %}
{% block title %}Liste des utilisateurs{% endblock %}

{% block page_button %}
<a href="/sync_users" class="btn btn-primary">ğŸ”„ Synchroniser les utilisateurs</a>
{% endblock %}

{% block content %}
<style>
.text-orange { color: #fd7e14; }
.table-orange { background-color: #fff3cd; }
</style>

<div class="container mt-4">
    <!-- Tableau -->
    <div class="table-responsive mt-3">
        <table id="usersTable" class="table table-sm table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th class="d-none">_rank</th><!-- colonne cachÃ©e: 0 normal, 1 retirÃ© -->
                    <th>ID</th>
                    <th>Avatar</th>
                    <th>Nom d'utilisateur</th>
                    <th>Email</th>
                    <th>ğŸ“Œ Statut</th>
                    <th>â³ Jours restants</th>
                    <th>ğŸ“… Date de fin</th>
                </tr>
            </thead>
            <tbody id="user-table">
                {% for user in users %}
				<tr 
				  class="{% if user.status == 'active' %}table-success
						 {% elif user.status == 'pre_expired' %}table-warning
						 {% elif user.status == 'reminder' %}table-orange
						 {% elif user.status == 'expired' %}table-danger
						 {% elif user.status == 'invited' %}table-info
						 {% elif user.status == 'unfriended' %}table-secondary
						 {% elif user.status == 'unknown' %}table-secondary
						 {% elif user.status == 'suspended' %}table-dark
						 {% else %}table-light{% endif %}" 
				  data-user-id="{{ user.id }}">
                    <!-- cellule _rank cachÃ©e -->
                    <td class="d-none status-rank">{{ 1 if user.status == 'unfriended' else 0 }}</td>

                    <td>{{ user.id }}</td>
                    <td>
                        {% if user.avatar %}
                        <img src="{{ user.avatar }}" alt="Avatar" width="40" class="rounded-circle">
                        {% else %}
                        âŒ Pas d'avatar
                        {% endif %}
                    </td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
					<td>
					  <span class="{% if user.status == 'active' %}text-success
								   {% elif user.status == 'pre_expired' %}text-warning
								   {% elif user.status == 'reminder' %}text-orange
								   {% elif user.status == 'expired' %}text-danger
								   {% elif user.status == 'invited' %}text-info
								   {% elif user.status == 'unfriended' %}text-secondary
								   {% elif user.status == 'unknown' %}text-secondary
								   {% elif user.status == 'suspended' %}text-dark
								   {% else %}text-muted{% endif %}">
						{{ _(user.status) }}
					  </span>
					</td>
					<!-- âš ï¸ DataTables lit data-order pour trier -->
					<td class="col-days"
						data-order="{{ user.jours_restants if user.jours_restants is not none else 999999 }}">
					  {{ user.jours_restants if user.jours_restants is not none else 'â€”' }}
					</td>
					<td>{{ user.expiration_date if user.expiration_date else 'Inconnu' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Graphique -->
	<h4 class="text-center mt-4 mb-2">ğŸ‘¥ Nombre total : {{ users|length }}</h4>
    <div class="mt-4">
        <h2 class="text-center">ğŸ“Š RÃ©partition des utilisateurs</h2>
        <canvas id="usersChart"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- JS + Bootstrap + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
	// Redirection au clic
	document.querySelectorAll("#usersTable tbody tr").forEach(function (row) {
		row.addEventListener("click", function () {
			const userId = this.getAttribute("data-user-id");
			if (userId) {
				navigateToUser(userId);
			}
		});
	});

    // DataTables
    // colonnes (aprÃ¨s ajout de _rank en 1Ã¨re position) :
    // 0=_rank, 1=ID, 2=Avatar, 3=Nom, 4=Email, 5=Statut, 6=Jours, 7=Date
    $('#usersTable').DataTable({
        paging: true,
		order: [[6, 'asc']], // tri par Jours restants
        orderFixed: { pre: [[0, 'asc']] }, // garde toujours _rank=0 avant _rank=1 â†’ â€œRetirÃ©â€ en bas
		stateSave: true,
        pageLength: 10,
        lengthChange: false,
        ordering: true,
        info: false,
        searching: true,
        columnDefs: [
            { targets: 0, visible: false, searchable: false }, // cache _rank
            { targets: 2, orderable: false },                  // avatar non triable
            { targets: 6, type: 'num' }                        // tri numÃ©rique sur jours
        ],
        language: {
            search: "ğŸ” Rechercher :",
            paginate: {
                first: "Premier",
                last: "Dernier",
                next: "Suivant",
                previous: "PrÃ©cÃ©dent"
            }
        },
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'csvHtml5',
                text: 'ğŸ“¥ Exporter CSV',
                className: 'btn btn-primary'
            }
        ]
    });

	// Graphique
	var actifs = {{ users | selectattr('status', 'equalto', 'active') | list | length }};
	var preavis = {{ users | selectattr('status', 'equalto', 'pre_expired') | list | length }};
	var reminder = {{ users | selectattr('status', 'equalto', 'reminder') | list | length }};
	var expires = {{ users | selectattr('status', 'equalto', 'expired') | list | length }};
	var invites = {{ users | selectattr('status', 'equalto', 'invited') | list | length }};
	var unfriends = {{ users | selectattr('status', 'equalto', 'unfriended') | list | length }};
	var unknown = {{ users | selectattr('status', 'equalto', 'unknown') | list | length }};
	var suspendus = {{ users | selectattr('status', 'equalto', 'suspended') | list | length }};

	const ctx = document.getElementById('usersChart').getContext('2d');
	new Chart(ctx, {
		type: 'bar',
		data: {
			labels: ['Actif', 'PrÃ©avis', 'Rappel', 'ExpirÃ©', 'InvitÃ©', 'RetirÃ©', 'Inconnu', 'Suspendu'],
			datasets: [{
				label: "Utilisateurs par status",
				data: [actifs, preavis, reminder, expires, invites, unfriends, unknown, suspendus],
				backgroundColor: [
					'rgba(75, 192, 192, 0.5)',    // active
					'rgba(255, 206, 86, 0.5)',    // pre_expired
					'rgba(255, 159, 64, 0.5)',    // reminder
					'rgba(255, 99, 132, 0.5)',    // expired
					'rgba(13, 202, 240, 0.5)',    // invited
					'rgba(108, 117, 125, 0.5)',   // unfriended
					'rgba(111, 66, 193, 0.5)',    // unknown
					'rgba(33, 37, 41, 0.5)'       // suspended
				],
				borderColor: [
					'rgba(75, 192, 192, 1)',
					'rgba(255, 206, 86, 1)',
					'rgba(255, 159, 64, 1)',
					'rgba(255, 99, 132, 1)',
					'rgba(13, 202, 240, 1)',
					'rgba(108, 117, 125, 1)',
					'rgba(111, 66, 193, 1)',
					'rgba(33, 37, 41, 1)'
				],
				borderWidth: 1
			}]
		},
		options: {
			responsive: true,
			scales: {
				y: { beginAtZero: true }
			}
		}
	});
});

function navigateToUser(id) {
  window.parent.postMessage({ action: "navigate", target: `/edit_user/${id}` }, "*");
}
</script>

<script>
async function checkUserRefresh() {
  try {
    const res = await fetch("/api/should-refresh/users");
    const data = await res.json();
    if (!data.refresh) return;

    // 1) RÃ©cupÃ¨re le fragment HTML serveur
    const html = await fetch("/api/users").then(r => r.text());

    // 2) Remplace le contenu du <tbody>
    const tbody = document.getElementById("user-table");
    tbody.innerHTML = html;

    // 3) RÃ©-attache le clic sur chaque ligne
    tbody.querySelectorAll("tr").forEach(row => {
      row.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        if (userId) {
          navigateToUser(userId);
        }
      });
    });

    // 4) Informe DataTables que les donnÃ©es ont changÃ©
    if ($.fn.DataTable.isDataTable('#usersTable')) {
      const dt = $('#usersTable').DataTable();
      dt.rows().invalidate().draw(false); // false => ne pas reset pagination/tri
    }

    // 5) RÃ©initialise le flag cÃ´tÃ© serveur
    await fetch("/api/clear-refresh/users", { method: "POST" });
  } catch (e) {
    console.error("Refresh users failed:", e);
  }
}
</script>

{% endblock %}
